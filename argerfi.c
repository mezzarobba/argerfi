/* argerfi.c
 *
 * Quick-and-dirty implementation of the inverse imaginary error function,
 * relative accuracy about 2^(-40)
 *
 * Build with:
 *
 *     gcc -std=c11 argerfi.c -lm
 *
 * or (test mode):
 *
 *     gcc -std=c11 -DTEST argerfi.c -lm -lcerf
 *
 * Author: Marc Mezzarobba (CNRS & Universit√© Pierre et Marie Curie), May 2017
 * Adapted in part from code generated by Metalibm-lutetia
 * <URL: http://www.metalibm.org/lutetia.html>
 * Public Domain
 *
 */


#include <math.h>
#include <stdbool.h>
#include <stdio.h>
#include <stdlib.h>

#ifdef TEST
#include <cerf.h>
#endif

static double argerfi0 (double x) {

    double tmp;
    double x2 = x * x;

    tmp = -1.72450211942930687475383777496062975842505693435668945312500000000000000000000000e-03;
    tmp = tmp * x;
    tmp = 1.09419121149464067202557673436965075991352490652336326704130442522000521421432495e-15 + tmp;
    tmp = tmp * x;
    tmp = 7.73875906432820725999732758282334543764591217041015625000000000000000000000000000e-03 + tmp;
    tmp = tmp * x2;
    tmp = -1.72864411061401206104459760126701439730823040008544921875000000000000000000000000e-02 + tmp;
    tmp = tmp * x2;
    tmp = 2.69316060052088163123684694255643989890813827514648437500000000000000000000000000e-02 + tmp;
    tmp = tmp * x2;
    tmp = -3.49733794461438013412291070380888413637876510620117187500000000000000000000000000e-02 + tmp;
    tmp = tmp * x2;
    tmp = 4.25125315015462551526681522773287724703550338745117187500000000000000000000000000e-02 + tmp;
    tmp = tmp * x2;
    tmp = -5.16838747430405434646338846960134105756878852844238281250000000000000000000000000e-02 + tmp;
    tmp = tmp * x2;
    tmp = 6.49551595793521480137755474970617797225713729858398437500000000000000000000000000e-02 + tmp;
    tmp = tmp * x2;
    tmp = -8.65518795320478068200387156139186117798089981079101562500000000000000000000000000e-02 + tmp;
    tmp = tmp * x2;
    tmp = 1.27556168033736400113653530752344522625207901000976562500000000000000000000000000e-01 + tmp;
    tmp = tmp * x2;
    tmp = -2.32013666451369421350747757060162257403135299682617187500000000000000000000000000e-01 + tmp;
    tmp = tmp * x2;
    tmp = 8.86226925452599734178704693476902320981025695800781250000000000000000000000000000e-01 + tmp;
    tmp = tmp * x;

    return tmp;

}

static double argerfi1 (double x) {

    double tmp;

    tmp = 1.98065276289309737751866830057778656737355049699544906616210937500000000000000000e-05;
    tmp = tmp * x;
    tmp = -1.47434402973099033850104544463022193667711690068244934082031250000000000000000000e-04 + tmp;
    tmp = tmp * x;
    tmp = 3.07437492423010710375363974122819854528643190860748291015625000000000000000000000e-04 + tmp;
    tmp = tmp * x;
    tmp = -3.10480321740301740997269863697738401242531836032867431640625000000000000000000000e-04 + tmp;
    tmp = tmp * x;
    tmp = -9.01068289645564436457156332060947079298784956336021423339843750000000000000000000e-05 + tmp;
    tmp = tmp * x;
    tmp = 1.25705635520734367548134624570366213447414338588714599609375000000000000000000000e-03 + tmp;
    tmp = tmp * x;
    tmp = -3.37118467137776604142240799433238862548023462295532226562500000000000000000000000e-03 + tmp;
    tmp = tmp * x;
    tmp = 5.60927490940405556324455105254855880048125982284545898437500000000000000000000000e-03 + tmp;
    tmp = tmp * x;
    tmp = -4.60657150282321042888966644568427000194787979125976562500000000000000000000000000e-03 + tmp;
    tmp = tmp * x;
    tmp = -8.10692448882266089582593338036531349644064903259277343750000000000000000000000000e-03 + tmp;
    tmp = tmp * x;
    tmp = 5.01980461044955611482620838614820968359708786010742187500000000000000000000000000e-02 + tmp;
    tmp = tmp * x;
    tmp = -1.57405355150246256679125167465826962143182754516601562500000000000000000000000000e-01 + tmp;
    tmp = tmp * x;
    tmp = 4.30346039237340105554352476247004233300685882568359375000000000000000000000000000e-01 + tmp;
    tmp = tmp * x;
    tmp = 8.49931417155032953303361864527687430381774902343750000000000000000000000000000000e-01 + tmp;

    return tmp;
}

static double aux00 (double x) {

    double tmp;

    tmp = 6.06311639573021579963096883147954940795898437500000000000000000000000000000000000e+02;
    tmp = tmp * x;
    tmp = -1.97444428668814055072289193049073219299316406250000000000000000000000000000000000e+02 + tmp;
    tmp = tmp * x;
    tmp = -1.26835766138597080043837195262312889099121093750000000000000000000000000000000000e+02 + tmp;
    tmp = tmp * x;
    tmp = 8.60550706951499932984006591141223907470703125000000000000000000000000000000000000e+01 + tmp;
    tmp = tmp * x;
    tmp = -1.61483615516109999532545771216973662376403808593750000000000000000000000000000000e+01 + tmp;
    tmp = tmp * x;
    tmp = -4.03202531148863929644221570924855768680572509765625000000000000000000000000000000e+00 + tmp;
    tmp = tmp * x;
    tmp = 1.32350773300209900718016342580085620284080505371093750000000000000000000000000000e+00 + tmp;
    tmp = tmp * x;
    tmp = 1.05531195433703572916783741675317287445068359375000000000000000000000000000000000e+00 + tmp;
    tmp = tmp * x;
    tmp = 1.26150075417312335090969099837820976972579956054687500000000000000000000000000000e+00 + tmp;
    tmp = tmp * x;
    tmp = -2.37612554187083002688041233341209590435028076171875000000000000000000000000000000e+00 + tmp;
    tmp = tmp * x;
    tmp = 5.90106278953546836696375521569279953837394714355468750000000000000000000000000000e-01 + tmp;
    tmp = tmp * x;
    tmp = 9.23753333583310465293436664069304242730140686035156250000000000000000000000000000e-01 + tmp;
    tmp = tmp * x;
    tmp = -5.82356380644627913412136877013836055994033813476562500000000000000000000000000000e-01 + tmp;
    tmp = tmp * x;
    tmp = -1.67539468196461094340321551499073393642902374267578125000000000000000000000000000e-01 + tmp;
    tmp = tmp * x;
    tmp = -4.11161152061931128853800032629806082695722579956054687500000000000000000000000000e-02 + tmp;
    tmp = tmp * x;
    tmp = 7.48444521809489726749120563908945769071578979492187500000000000000000000000000000e-01 + tmp;
    tmp = tmp * x;
    tmp = 5.47393351747116563288386714702937752008438110351562500000000000000000000000000000e-01 + tmp;

    return tmp;
}

static double aux01 (double x) {

    double tmp;

    tmp = 3.37529207696620037193468988334643654525279998779296875000000000000000000000000000e-01;
    tmp = tmp * x;
    tmp = -3.45666452763353448940364387453882955014705657958984375000000000000000000000000000e-01 + tmp;
    tmp = tmp * x;
    tmp = 7.84105022888817865256427808162698056548833847045898437500000000000000000000000000e-02 + tmp;
    tmp = tmp * x;
    tmp = 1.82564382858233620332555346976732835173606872558593750000000000000000000000000000e-01 + tmp;
    tmp = tmp * x;
    tmp = -2.87828762854500042056571373905171640217304229736328125000000000000000000000000000e-01 + tmp;
    tmp = tmp * x;
    tmp = 1.99719719172278181718027667557180393487215042114257812500000000000000000000000000e-01 + tmp;
    tmp = tmp * x;
    tmp = 5.33614842926807570605562958121481642592698335647583007812500000000000000000000000e-03 + tmp;
    tmp = tmp * x;
    tmp = -1.80790066485606915058781396510312333703041076660156250000000000000000000000000000e-01 + tmp;
    tmp = tmp * x;
    tmp = 1.94090222712360510604057139971700962632894515991210937500000000000000000000000000e-01 + tmp;
    tmp = tmp * x;
    tmp = -2.63593549092663989238949362459152325754985213279724121093750000000000000000000000e-03 + tmp;
    tmp = tmp * x;
    tmp = -3.10893452786881574478883294432307593524456024169921875000000000000000000000000000e-01 + tmp;
    tmp = tmp * x;
    tmp = 5.57307026250828840829854016192257404327392578125000000000000000000000000000000000e-01 + tmp;
    tmp = tmp * x;
    tmp = 8.57595539617681090760470397071912884712219238281250000000000000000000000000000000e-01 + tmp;
    return tmp;

}

static double aux10 (double x) {

    double tmp;

    tmp = 4.14204243883646267931908369064331054687500000000000000000000000000000000000000000e+03;
    tmp = tmp * x;
    tmp = -2.41103753500068160064984112977981567382812500000000000000000000000000000000000000e+03 + tmp;
    tmp = tmp * x;
    tmp = -5.24149419502878345156204886734485626220703125000000000000000000000000000000000000e+02 + tmp;
    tmp = tmp * x;
    tmp = -6.51401841282095883656211299239657819271087646484375000000000000000000000000000000e+00 + tmp;
    tmp = tmp * x;
    tmp = 1.73708928946455962716299836756661534309387207031250000000000000000000000000000000e+01 + tmp;
    tmp = tmp * x;
    tmp = 1.30052551431502672052431535121286287903785705566406250000000000000000000000000000e+00 + tmp;
    tmp = tmp * x;
    tmp = 2.02306410118410662235532981867436319589614868164062500000000000000000000000000000e+00 + tmp;
    tmp = tmp * x;
    tmp = -6.85789672449709786228311259037582203745841979980468750000000000000000000000000000e-01 + tmp;
    tmp = tmp * x;
    tmp = 6.68409778702533374783456565637607127428054809570312500000000000000000000000000000e-01 + tmp;
    tmp = tmp * x;
    tmp = 3.75065595590126851788248529828706523403525352478027343750000000000000000000000000e-02 + tmp;
    tmp = tmp * x;
    tmp = -3.38855767887409842220591826844611205160617828369140625000000000000000000000000000e-01 + tmp;
    tmp = tmp * x;
    tmp = 8.91325803378018699518747780530247837305068969726562500000000000000000000000000000e-01 + tmp;
    tmp = tmp * x;
    tmp = 2.00671687819029248567304080097528640180826187133789062500000000000000000000000000e-01 + tmp;

    return tmp;

}

static double aux11 (double x) {

    double tmp;

    tmp = 3.46795161186450013701687566936016082763671875000000000000000000000000000000000000e+03;
    tmp = tmp * x;
    tmp = -4.09601663960055645929969614371657371520996093750000000000000000000000000000000000e+02 + tmp;
    tmp = tmp * x;
    tmp = -2.29020265988292919701052596792578697204589843750000000000000000000000000000000000e+02 + tmp;
    tmp = tmp * x;
    tmp = 5.93398763684782082350466225761920213699340820312500000000000000000000000000000000e+01 + tmp;
    tmp = tmp * x;
    tmp = 1.06700309685231680134620546596124768257141113281250000000000000000000000000000000e+01 + tmp;
    tmp = tmp * x;
    tmp = -5.22471978165900541313249050290323793888092041015625000000000000000000000000000000e+00 + tmp;
    tmp = tmp * x;
    tmp = -1.49095062589937987773680561076616868376731872558593750000000000000000000000000000e+00 + tmp;
    tmp = tmp * x;
    tmp = 4.83338955776125844820967358828056603670120239257812500000000000000000000000000000e-01 + tmp;
    tmp = tmp * x;
    tmp = 4.06956926242374839031157307545072399079799652099609375000000000000000000000000000e-01 + tmp;
    tmp = tmp * x;
    tmp = -2.36744837232083948919125759857706725597381591796875000000000000000000000000000000e-01 + tmp;
    tmp = tmp * x;
    tmp = 7.99538034796534069492679464019602164626121520996093750000000000000000000000000000e-01 + tmp;
    tmp = tmp * x;
    tmp = 3.28784816028654724995305969059700146317481994628906250000000000000000000000000000e-01 + tmp;

    return tmp;

}

static double aux20 (double x) {

    double tmp;

    tmp = 2.60473932540886278729885816574096679687500000000000000000000000000000000000000000e+05;
    tmp = tmp * x;
    tmp = -2.33564594901411328464746475219726562500000000000000000000000000000000000000000000e+04 + tmp;
    tmp = tmp * x;
    tmp = 2.04648686971947950041794683784246444702148437500000000000000000000000000000000000e+03 + tmp;
    tmp = tmp * x;
    tmp = -2.50022069260572834537015296518802642822265625000000000000000000000000000000000000e+02 + tmp;
    tmp = tmp * x;
    tmp = 3.55438776487622405397814873140305280685424804687500000000000000000000000000000000e+01 + tmp;
    tmp = tmp * x;
    tmp = -7.03886280982183532017870675190351903438568115234375000000000000000000000000000000e+00 + tmp;
    tmp = tmp * x;
    tmp = 2.39396760074561276709914636739995330572128295898437500000000000000000000000000000e+00 + tmp;
    tmp = tmp * x;
    tmp = -6.97014146913158660900933227821951732039451599121093750000000000000000000000000000e-01 + tmp;
    tmp = tmp * x;
    tmp = -2.25541790887519494335222702829923946410417556762695312500000000000000000000000000e-01 + tmp;
    tmp = tmp * x;
    tmp = 9.83387550392985088087982603610726073384284973144531250000000000000000000000000000e-01 + tmp;
    tmp = tmp * x;
    tmp = 6.03748588258516336035874871868145419284701347351074218750000000000000000000000000e-02 + tmp;

    return tmp;

}

static double aux21 (double x) {

    double tmp;

    tmp = 1.09770277548211140583589440211653709411621093750000000000000000000000000000000000e+02;
    tmp = tmp * x;
    tmp = -2.26395378759707135429835034301504492759704589843750000000000000000000000000000000e+01 + tmp;
    tmp = tmp * x;
    tmp = 6.23349253162273875261689681792631745338439941406250000000000000000000000000000000e+00 + tmp;
    tmp = tmp * x;
    tmp = -2.50429831305110139894054555043112486600875854492187500000000000000000000000000000e+00 + tmp;
    tmp = tmp * x;
    tmp = 1.37225973391138622581308936787536367774009704589843750000000000000000000000000000e+00 + tmp;
    tmp = tmp * x;
    tmp = -3.41410194089177942977642032928997650742530822753906250000000000000000000000000000e-01 + tmp;
    tmp = tmp * x;
    tmp = -3.00215381648179013840405104929232038557529449462890625000000000000000000000000000e-01 + tmp;
    tmp = tmp * x;
    tmp = 9.56931011404687614785302685049828141927719116210937500000000000000000000000000000e-01 + tmp;
    tmp = tmp * x;
    tmp = 1.08428042152049999846674666059698211029171943664550781250000000000000000000000000e-01 + tmp;

    return tmp;

}

double argerfi (double x) {
    bool neg = false;
    double res;
    if (x < 0.) {
        neg = true;
        x = -x;
    }
    if (x < 0.75)
        res = argerfi0(x);
    else if (x < 1.75)
        res = argerfi1(x - 1.25);
    else {
        double s = 1/sqrt(log(x));
        double res1;
        if (s > 0.8777500000000000301980662698042578995227813720703125)
            res1 = aux01(s - 1.107275000000000009237055564881302416324615478515625);
        else if (s > 0.4195)
            res1 = aux00(s - 0.648225000000000051159076974727213382720947265625);
        else if (s > 0.285999999999999976463271877946681343019008636474609375)
            res1 = aux11(s - 0.362);
        else if (s > 0.1342)
            res1 = aux10(s - 0.2099999999999999922284388276239042170345783233642578125);
        else if (s > 8.55e-2)
            res1 = aux21(s - 0.11025);
        else
            res1 = aux20(s - 6.075e-2);
        res = 1/res1;
    }
    if (neg)
        return -res;
    else
        return res;
}

#ifdef TEST

void test (double a, double b, int n) {
    for (int k=0; k<n; ++k) {
        double x = a + k*(b - a)/n;
        double y = erfi(x);
        double z = argerfi(y);
        printf("%.16g %.16g\n", x, z/x - 1);
    }
}

int main (int argc, char** argv) {
    if (argc != 3) {
        fprintf(stderr, "Usage: %s a b \n", argv[0]);
        return 1;
    }
    double a = strtod(argv[1], NULL);
    double b = strtod(argv[2], NULL);
    test(a, b, 10000);
    return 0;
}

#else

 int main(int argc, char **argv) {
    if (argc != 2) {
        fprintf(stderr, "Usage: %s x\n", argv[0]);
        return 1;
    }
    double x = strtod(argv[1], NULL);
    double y = argerfi(x);
    printf("%.16f\n", y);
    return 0;
}

#endif
